#!/usr/bin/make -f

# resolve variables DEB_TARGET_GNU_CPU DEB_TARGET_GNU_SYSTEM
include /usr/share/dpkg/architecture.mk

export CARGO_NET_OFFLINE  = true
export CARGO_HOME         = $(CURDIR)/debian/build/cargo-home
export CARGO_INSTALL_ROOT = $(CURDIR)/debian/tmp

# generate documentation unless nodoc requested
ifeq (,$(filter nodoc,$(DEB_BUILD_OPTIONS)))
MANPAGES = debian/build/precious.1
endif

# generate manpage with help2man from --help option of executable
_mkman = help2man $(if $3,--name "$(strip $3)") --no-info --output $2 $1 \
 || { $1 --help; false; }

# TODO: simplify when librust-path-clean is in Debian
%:
#	dh $@ --buildsystem cargo
	dh $@

execute_before_dh_auto_configure:
	CARGO_NET_OFFLINE=false cargo fetch --locked --target "${DEB_TARGET_GNU_CPU}-unknown-${DEB_TARGET_GNU_SYSTEM}"

override_dh_auto_build:
	cargo build --release

# TODO: enable when <https://github.com/houseabsolute/precious/issues/15> is fixed
override_dh_auto_test:
#	cargo test

execute_after_dh_auto_install: $(MANPAGES)

# build manpages
debian/build/precious.1: debian/build/%.1: target/release/%
	mkdir --parents $(dir $@)
	$(call _mkman, $<, $@, \
		one code quality tool to rule them all)
