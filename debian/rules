#!/usr/bin/make -f

# generate documentation unless nodoc requested
ifeq (,$(filter nodoc,$(DEB_BUILD_OPTIONS)))
DOCS = README.html README.txt
CHANGELOGS = Changes.html Changes.txt
MANPAGES = debian/build/precious.1
endif

export CARGO_HOME = $(CURDIR)/debian/cargo_home
export CARGO_NET_OFFLINE = true

EXTRALIBS = path-clean-0.1.0

# generate manpage with help2man from --help option of executable
_mkman = help2man $(if $3,--name "$(strip $3)") --no-info --output $2 $1 \
 || { $1 --help; false; }

# generate cargo-checksum file
_mkchecksum = printf '{"package":"%s","files":{}}\n' \
 $$(sha256sum $(or $2,$(dir $1)Cargo.toml) | grep -Po '^\S+') > $1;

execute_before_dh_auto_configure:
	$(call _mkchecksum,debian/cargo-checksum.json,Cargo.toml)

# preserve upstream Cargo.lock during build, if provided
	[ -f Cargo.lock.orig ] || [ ! -f Cargo.lock ] \
		|| cp Cargo.lock Cargo.lock.orig

execute_after_dh_auto_configure:
	ln --symbolic --target-directory=debian/cargo_registry $(patsubst %,../extralibs/%,$(EXTRALIBS))

# use and update local Cargo.lock, if available
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	[ ! -f debian/Cargo.lock ] || cp -f debian/Cargo.lock Cargo.lock
	[ ! -f debian/Cargo.lock ] || cargo update
endif

execute_after_dh_auto_build: $(DOCS) $(CHANGELOGS)

execute_after_dh_auto_install: $(MANPAGES)

override_dh_installdocs:
	dh_installdocs --all -- $(DOCS)

override_dh_installchangelogs:
	dh_installchangelogs -- $(CHANGELOGS)

execute_after_dh_auto_clean:
	[ ! -f Cargo.lock.orig ] || mv -f Cargo.lock.orig Cargo.lock

# build manpages
debian/build/precious.1: debian/build/%.1: debian/precious/usr/bin/%
	mkdir --parents $(dir $@)
	$(call _mkman, $<, $@, \
		one code quality tool to rule them all)

%.html: %.md
	cmark-gfm $< > $@

%.txt: %.md
	cmark-gfm --to plaintext $< > $@

%:
	dh $@ --buildsystem cargo

# custom target unused during official build
fetch-extralibs: CARGO_NET_OFFLINE = false
fetch-extralibs: export CARGO_HOME = $(CURDIR)/debian/cargo_vendor_home
fetch-extralibs:
# preserve upstream Cargo.lock, and reset to use that
	[ -f Cargo.lock.orig ] || cp Cargo.lock Cargo.lock.orig
	cp -f Cargo.lock.orig Cargo.lock

	cargo vendor --versioned-dirs debian/build/extralibs
	rm -rf debian/extralibs
	mkdir debian/extralibs
	mv --target-directory=debian/extralibs $(patsubst %,debian/build/extralibs/%,$(EXTRALIBS))
	rm -rf debian/build

# preserve mangled Cargo.lock for use during build
	sed -e '/^checksum / d' Cargo.lock > debian/Cargo.lock
