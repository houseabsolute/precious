# Based on the "trust" template v0.1.2
# https://github.com/japaric/trust/tree/v0.1.2
language: rust
cache: cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

env:
  global:
    - CRATE_NAME=precious
    - RUST_BACKTRACE=1
    - secure: "JvMFmx8/Y5nXgi4b049V2BzR7SaSCEfsx6w4bgKBlXgw3ZxAcD7kbxY3HWyIHx3y6yzOYTvOkX9cCNug2YIiYrZoh8iESTHm05nVpq56yHBSvPAr0GVG1tyV91NihKNrWQ4hZCNp/Bnuczm5H4R/Ht5m3W5cy38fX8CPeablQi0Jephw3zEBEq7eYvgpZX6koxtngD3ucX/gZaaEsI8+JVwyb/EysoIdsJ3MvNp1Cm0abu3mf+oJXYnx2WxvvG0MFzNtt0oFF/L07mpWkaahD4JJP1hdJhPYsHDb3pv+1lpUDvlhEhqba5m6MHGmv8LRFiQaRw//aY2x5lpuYOZyftqk0KxsorKpL3GSan+4i/pevflSgINe8uc6hWoaT7IVwqu+0dDEL2fbrI7ZrgxCCLr6GdK4ICOMn14ZAlgSsqd8gj8IqUw+BoPIRp8jcBYK6ll1VTu9WeMsemGhNWrtywxD7e1SZSpeOpTatd5xwrlHBkZDBrA5UGfBjzIaYnjhzCGpxBjGcLbjmi57UgjkNUNbtyB4hne/HGEHLvxOYCPRI46jDWTvUgb8XTTJepU67YEVliuD4ISsm/ayaj683aZXZE+TXoCThQUuMNqAjmLNafngC9BwCt+Jm49xv+cidSgdrn0lOxUZEmGTJd4gEVM84CJGOuZpMDdiTHYLX1g="

matrix:
  fast_finish: true
  allow_failures:
    - env: NAME='coverage'
  include:
    - env: NAME='self-check'
      rust: stable
      before_script:
        - rustup component add rustfmt
        - rustup component add clippy
      script:
        - cargo build && ./target/debug/precious lint -a
    - env: NAME='coverage'
      addons: # required for kcov
        apt:
          packages:
            - elfutils
            - libcurl4-openssl-dev
            - libelf-dev
            - libdw-dev
            - binutils-dev
            - cmake
      before_script:
        - cargo install cargo-update || echo "cargo-update already installed"
        - cargo install cargo-travis || echo "cargo-travis already installed"
        - cargo install-update -a
      script:
        - |
          cargo build    --verbose &&
          cargo test     --verbose &&
          cargo bench    --verbose &&
          cargo coverage --verbose
      after_success:
        - cargo coveralls

    - env: RUN_TESTS=1
      rust: stable
    - env: RUN_TESTS=1
      rust: beta
    - env: RUN_TESTS=1
      rust: nightly

    # Linux
    - env:
        - TARGET=x86_64-unknown-linux-gnu
        - DEPLOY=1
      rust: stable

    # OSX
    - env:
        - TARGET=x86_64-apple-darwin
        - DEPLOY=1
      os: osx
      rust: stable

    # *BSD
    - env:
        - TARGET=x86_64-unknown-netbsd
        - DEPLOY=1
      rust: stable

    # Windows
    - env:
        - TARGET=x86_64-pc-windows-gnu
        - DEPLOY=1
      rust: stable

before_install:
  - set -e
  - rustup self update

install:
  - sh ci/install.sh
  - source ~/.cargo/env || true

script:
  - bash ci/script.sh

after_script: set +e

before_deploy:
  - sh ci/before_deploy.sh

deploy:
  provider: releases
  api_key:
    secure: "UqTTdWOrIcWbLwnY9ktUGPRNFQ+pjrkdBhd5sHApqF9YbEyYko9jY1GCijJ3JRiP84Z77Xw9YmZJssX4+Gk+8zQWaKhs80Zmb76/WicitqooHzDM/j3bGfA89LKHE/XXtF2YtRkF9xRW8jqXPtdr3Z9EOEYSvC442H919gkGuxWj97xTkuEmqRzxk6680z2aWiXUwpDnsM6YA/TcbL5JmLCOaQ+IpWKymU4s38rbIRHkNQw17ldddbeQBpCeB4nLxd31XucGzuYEB49tyLFKxR0gz5A7dat2uD2C8TXH1fHFT3gC7o/+DV70b0AE06PH51fvz17mw/0HN2mKmze289JBsQq6JzfIgklAA65Bzr/sS3sB9UghBGkN1K3gTE1xP02TOuhx1ErAMZkuf5VXzu3MBUaSKlLjarvIWK8u7Lt384C4jx0i3sAWo0sXC1NlrLz5lFWkMjhme1OraQBZoX9hwN5Ke9WAgYdngcS5o3lcN+WrGKH2l8Q71RTUY6e0MkKETgSAmJwNgZWlcDuH5N6joX6sFIUpdBmhrZQMaV+KGUVJLJUXYHp6PIPodTrsKYAOrBByKVcV5NaiXQcNup16WwwKnCIkj3G/v2J5GQGFfUx2v4WYj+ZKgb3QSBvledeztrzJIlDj+W3Ox6CTrccH9zffgdcSUMoGYwN7TT8="
  file_glob: true
  file: $CRATE_NAME-$TRAVIS_TAG-$TARGET.*
  on:
    condition:
      - $DEPLOY = 1
    tags: true
  skip_cleanup: true
